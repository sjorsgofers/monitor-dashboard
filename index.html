<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=1920, initial-scale=1" />
  <title>Zusje Roermond Dashboard</title>
  <style>
    html, body {
      height:100%; margin:0; background:#000; overflow:hidden;
      -webkit-text-size-adjust:100%; text-size-adjust:100%;
    }

    #dashboard-shell{
      position:fixed; inset:0;
      background:#f3f6fb;
      overflow:hidden;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    }

    .zd-stage{ position:relative; width:100%; height:100%; }
    .zd-frame{
      position:absolute;
      left:50%; top:50%;
      width:1920px; height:1080px;
      transform: translate(-50%, -50%) scale(1);
      transform-origin: center center;
      will-change: transform;
    }

    .zd-wrap{ width:100%; height:100%; padding:28px; color:#0b1220; background:#f3f6fb; }
    .zd-header{ display:flex; align-items:flex-end; justify-content:space-between; margin-bottom:24px; }
    .zd-title{
      font-weight:900; font-size:56px; letter-spacing:.2px;
      background:linear-gradient(90deg,#2563eb,#06b6d4);
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    .zd-meta{ color:#60708d; font-size:22px; margin-top:8px; }
    .zd-clock{
      font-variant-numeric:tabular-nums; font-weight:900;
      font-size:64px; color:#0f172a; text-align:right;
    }
    .zd-date{ color:#60708d; font-size:22px; text-align:right; }

    .zd-grid{
      display:grid; gap:24px;
      grid-template-columns: repeat(12, 1fr);
      height: calc(100% - 110px);
    }
    .zd-col-4{ grid-column:span 4; }

    .zd-panel{
      background:#eef2f7; border:1px solid #dde3ef;
      border-radius:28px; padding:14px;
      box-shadow:0 20px 50px rgba(15,23,42,.08);
    }
    .zd-card{
      background:#ffffff; border:1px solid #e5e7eb; border-radius:22px;
      box-shadow:0 10px 28px rgba(15,23,42,.10);
      display:flex; flex-direction:column; overflow:hidden; min-height:170px;
    }
    .zd-band{ height:10px; width:100%; }
    .zd-band-check{  background:linear-gradient(90deg,#2563eb,#7ea5ff); }
    .zd-band-period{ background:linear-gradient(90deg,#0ea5a4,#8cf2e8); }
    .zd-band-orders{ background:linear-gradient(90deg,#f59e0b,#ffe29a); }
    .zd-band-waste{  background:linear-gradient(90deg,#16a34a,#a7f3d0); }

    .zd-card-h{
      padding:18px 20px; border-bottom:1px solid #eef2f7;
      font-weight:900; font-size:26px; color:#0f172a;
      background:linear-gradient(#ffffff,#fbfdff);
      display:flex; align-items:center; gap:10px;
    }
    .zd-tag{
      margin-left:auto; font-size:14px; font-weight:800; color:#0b1220;
      padding:6px 12px; border-radius:999px;
      border:1px solid #e5e7eb; background:#eef6ff;
    }
    .zd-card-b{
      padding:20px; gap:14px; display:flex;
      flex-direction:column; flex:1; overflow:auto;
    }

    .zd-list{ display:flex; flex-direction:column; gap:12px; }
    .zd-item{
      display:flex; align-items:center; justify-content:space-between;
      background:#f8fafc; padding:16px 18px;
      border-radius:14px; border:1px solid #e5e7eb;
    }
    .zd-name{
      font-weight:800; letter-spacing:.2px;
      font-size:22px; color:#0b1220;
    }
    .zd-name em{ font-style:normal; color:#64748b; font-weight:700; }

    .zd-chip{
      display:inline-flex; align-items:center; gap:8px;
      font-weight:900; font-size:18px; line-height:1;
      padding:10px 14px; border-radius:999px;
      border:1px solid transparent;
      box-shadow:0 6px 16px rgba(0,0,0,.06);
    }
    .zd-ok{   color:#065f46; border-color:rgba(16,185,129,.35); background:linear-gradient(180deg,#d1fae5,#a7f3d0); }
    .zd-warn{ color:#7c2d12; border-color:rgba(245,158,11,.4);  background:linear-gradient(180deg,#fef3c7,#fde68a); }
    .zd-bad{  color:#7f1d1d; border-color:rgba(239,68,68,.4);   background:linear-gradient(180deg,#fee2e2,#fecaca); }
    .zd-open{ color:#023047; border-color:rgba(6,182,212,.35);  background:linear-gradient(180deg,#cffafe,#bae6fd); }
  </style>
</head>
<body>
  <div id="dashboard-shell">
    <div class="zd-stage" id="zd-stage">
      <div class="zd-frame" id="zd-frame">
        <div class="zd-wrap">
          <div class="zd-header">
            <div>
              <div class="zd-title">Zusje Roermond Dashboard</div>
              <div class="zd-meta">Alleen items voor <strong>vandaag</strong> (horecadag t/m 04:00)</div>
            </div>
            <div style="text-align:right">
              <div class="zd-clock" id="zd-clock">--:--</div>
              <div class="zd-date" id="zd-date">—</div>
            </div>
          </div>

          <!-- 3 kolommen -->
          <div class="zd-grid">
            <!-- Kolom 1: Checklisten -->
            <div class="zd-col-4">
              <div class="zd-panel">
                <section class="zd-card">
                  <div class="zd-band zd-band-check"></div>
                  <div class="zd-card-h">Checklisten <span class="zd-tag">Team</span></div>
                  <div class="zd-card-b">
                    <div class="zd-list" id="zd-checklistList"></div>
                  </div>
                </section>
              </div>
            </div>

            <!-- Kolom 2: Containers + Emballage -->
            <div class="zd-col-4">
              <div class="zd-panel" style="margin-bottom:24px;">
                <section class="zd-card">
                  <div class="zd-band zd-band-waste"></div>
                  <div class="zd-card-h">Containers (vandaag) <span class="zd-tag">Buiten</span></div>
                  <div class="zd-card-b">
                    <div class="zd-list" id="zd-wasteContainers"></div>
                  </div>
                </section>
              </div>
              <div class="zd-panel">
                <section class="zd-card">
                  <div class="zd-band zd-band-waste"></div>
                  <div class="zd-card-h">Emballage (vandaag) <span class="zd-tag">Vast schema</span></div>
                  <div class="zd-card-b">
                    <div class="zd-list" id="zd-wasteEmballage"></div>
                  </div>
                </section>
              </div>
            </div>

            <!-- Kolom 3: Dagnotities + Bestellen -->
            <div class="zd-col-4">
              <div class="zd-panel" style="margin-bottom:24px;">
                <section class="zd-card">
                  <div class="zd-band zd-band-period"></div>
                  <div class="zd-card-h">Dagnotities en extra taken <span class="zd-tag">Schema</span></div>
                  <div class="zd-card-b">
                    <div class="zd-list" id="zd-periodicList"></div>
                  </div>
                </section>
              </div>
              <div class="zd-panel">
                <section class="zd-card">
                  <div class="zd-band zd-band-orders"></div>
                  <div class="zd-card-h">Bestellen (vandaag) <span class="zd-tag">Deadlines</span></div>
                  <div class="zd-card-b">
                    <div class="zd-list" id="zd-ordersList"></div>
                  </div>
                </section>
              </div>
            </div>
          </div><!-- /grid -->
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    /* ====== Endpoints ====== */
    const CONFIG = {
      sheets:{
        checklistsJson:"https://script.google.com/macros/s/AKfycbw_Tn0z0s3AJ7CARzHt9sFy8CGhrCe_HzS9ao0KKDtgzq9TR_H-28WBss316I6PDcr7/exec",
        periodicJson:"https://script.google.com/macros/s/AKfycbxEDSHzBOrrYqkNOCQI6clM6DNuoge55tdATn1XNC63HT7GgPcsZF5AT3dwfaLjEUmV/exec",
        containersJson:"https://script.google.com/macros/s/AKfycbwPQ1WsRqrJmRuYD8bL6kz5H5sSDNcBsIa0z-WW4hain7fkVhM6HIUQI3DHyhpn-C1zHQ/exec"
      },
      refreshMs:15000
    };

    /* ===== Emballage vast schema (0=zo..6=za) ===== */
    const EMBALLAGE_SCHEDULE = {
      0: ["Bidfood emballage klaarzetten"],   // zondag
      3: ["Bidfood emballage klaarzetten"],   // woensdag
      5: ["Bidfood emballage klaarzetten"]    // vrijdag
    };

    /* Containers fallback (als agenda niets geeft) */
    const FALLBACK_CONTAINERS = {
      0: ["Restafval containers klaarzetten"], // zo
      1: ["Glas containers klaarzetten"],      // ma
      2: ["Restafval containers klaarzetten"], // di
      3: [],                                   // wo
      4: ["Papier container klaarzetten"],     // do
      5: [],                                   // vr
      6: []                                    // za
    };
    const THURSDAY_PLASTIC_LABEL = "Plastic containers klaarzetten";

    /* Gele Zusje kratten: om de week op maandag, start 2025-11-17 */
    const YELLOW_CRATES_START = "2025-11-17";

    /* ====== State ====== */
    const state={
      checklists:[],
      periodicTasks:[],
      ordersRules:[
        {vendor:"Bidfood",weekdays:[2],deadline:"00:00"},              // di
        {vendor:"Bubbels",weekdays:[3],deadline:"23:00",evenWeeks:true},
        {vendor:"Zusje Kantoor",weekdays:[3],deadline:"23:00",evenWeeks:true},
        {vendor:"Bidfood",weekdays:[4],deadline:"00:00"},              // do
        {vendor:"Bidfood",weekdays:[6],deadline:"00:00"}               // za
      ]
    };
    let containersData = null;

    /* ====== Helpers ====== */
    const $=sel=>document.querySelector(sel);
    const pad=n=>String(n).padStart(2,"0");

    // Horecadag t/m 04:00
    const getOpsDate = (d)=>{
      const x=new Date(d||Date.now());
      if(x.getHours()<4) x.setDate(x.getDate()-1);
      return x;
    };

    const fmtDutchDate = d=>d.toLocaleDateString("nl-NL",{weekday:"long",day:"2-digit",month:"long"});

    const weekNumber = d=>{
      const t=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));
      const dn=(t.getUTCDay()+6)%7;
      t.setUTCDate(t.getUTCDate()-dn+3);
      const fT=new Date(Date.UTC(t.getUTCFullYear(),0,4));
      return 1+Math.round(((t-fT)/86400000-3+((fT.getUTCDay()+6)%7))/7);
    };
    const isEvenWeek = d=>weekNumber(d)%2===0;

    // YMD-string (YYYY-MM-DD) van NU met horecadag-cutoff
    const opsDateStrToday = ()=>{
      const d = getOpsDate(new Date());
      return d.toISOString().slice(0,10);
    };

    // YMD in Europe/Amsterdam voor een event-start (zonder 04:00-shift op het event zelf)
    const ymdInAmsterdam = (dateLike)=>{
      const tz="Europe/Amsterdam";
      if(!dateLike) return null;
      if(typeof dateLike==="string" && /^\d{4}-\d{2}-\d{2}/.test(dateLike)){
        // All-day "YYYY-MM-DD" → direct gebruiken
        return dateLike.slice(0,10);
      }
      const d = new Date(dateLike);
      if(isNaN(d)) return null;
      const parts = new Intl.DateTimeFormat("nl-NL",{
        timeZone: tz, year:"numeric", month:"2-digit", day:"2-digit"
      }).formatToParts(d);
      let y,m,da;
      for(const p of parts){
        if(p.type==="year") y=p.value;
        else if(p.type==="month") m=p.value;
        else if(p.type==="day") da=p.value;
      }
      return (y && m && da) ? `${y}-${m}-${da}` : null;
    };

    const chip=(type,label)=>`<span class="zd-chip ${type==='ok'?'zd-ok':type==='warn'?'zd-warn':type==='bad'?'zd-bad':'zd-open'}">${label||""}</span>`;

    /* ====== Data ====== */
    async function fetchChecklists(){
      try{
        const r=await fetch(CONFIG.sheets.checklistsJson,{cache:"no-store"});
        if(r.ok){
          const j=await r.json();
          if(Array.isArray(j.items)){
            state.checklists=j.items
              .map(it=>({name:String(it.name||"").trim(),done:!!it.done}))
              .filter(x=>x.name);
          }
        }
      }catch(e){ console.warn("Checklist fetch fail",e); }
    }

    async function fetchPeriodic(){
      const u=CONFIG.sheets.periodicJson;
      if(!u) return;
      try{
        const sep=u.includes("?")?"&":"?";
        const r=await fetch(u+sep+"tz=Europe/Amsterdam",{cache:"no-store"});
        if(r.ok){
          const j=await r.json();
          let items=(j && j.ok && Array.isArray(j.items)) ? j.items : [];
          const todayStr = opsDateStrToday();

          // Filter: toon alleen items waarvan de kalender-datum in Amsterdam gelijk is aan de horecadag
          items = items.filter(ev=>{
            const s = ev.start || ev.startTime || ev.date || ev.dateISO;
            if(!s) return true; // geen datum → tonen
            const evStr = ymdInAmsterdam(s);
            if(!evStr) return false;
            return evStr === todayStr;
          });

          state.periodicTasks = items.map(ev=>({
            title: ev.title,
            allDay: !!ev.allDay,
            start: ev.start || ev.startTime || ev.date || ev.dateISO || null
          }));
        }
      }catch(e){ console.warn("Periodic fail",e); }
    }

    async function fetchContainers(){
      const url = CONFIG.sheets.containersJson;
      if(!url) return null;
      try{
        const sep=url.includes("?")?"&":"?";
        const r = await fetch(url+sep+"tz=Europe/Amsterdam",{cache:"no-store"});
        if(!r.ok) throw new Error("HTTP "+r.status);
        return await r.json();
      }catch(e){
        console.warn("Containers endpoint faalde:", e);
        return null;
      }
    }

    async function loadAll(){
      const [a,b,c] = await Promise.allSettled([
        fetchChecklists(),
        fetchPeriodic(),
        fetchContainers()
      ]);
      containersData = (c && c.status==="fulfilled") ? c.value : null;
      renderAll();
    }

    /* ====== Render ====== */
    function renderHeader(){
      const n=new Date(), ops=getOpsDate(n);
      $("#zd-clock").textContent=`${pad(n.getHours())}:${pad(n.getMinutes())}:${pad(n.getSeconds())}`;
      $("#zd-date").textContent=fmtDutchDate(ops);
    }

    function renderChecklists(){
      const list=$("#zd-checklistList");
      list.innerHTML="";
      if(!state.checklists.length){
        list.innerHTML=`<div class="zd-item"><div class="zd-name">Geen checklists gevonden</div><div>${chip("open","—")}</div></div>`;
        return;
      }
      state.checklists.forEach(c=>{
        const el=document.createElement("div");
        el.className="zd-item";
        el.innerHTML=`<div class="zd-name">${c.name}</div><div>${c.done?chip("ok","✔ Gereed"):chip("open","Nog doen")}</div>`;
        list.appendChild(el);
      });
    }

    function renderPeriodic(){
      const list=$("#zd-periodicList");
      list.innerHTML="";
      const t=state.periodicTasks||[];
      if(!t.length){
        list.innerHTML=`<div class="zd-item"><div class="zd-name">Geen dagnotities of extra taken</div></div>`;
        return;
      }
      t.forEach(x=>{
        const el=document.createElement("div");
        el.className="zd-item";
        let prefix = "";
        // Alleen tijden tonen als er echt tijden zijn (niet bij hele-dag)
        if(x.start && !x.allDay){
          const d = new Date(x.start);
          const hh = pad(d.getHours());
          const mm = pad(d.getMinutes());
          prefix = `<em>${hh}:${mm}</em> — `;
        }
        el.innerHTML=`<div class="zd-name">${prefix}${x.title}</div>`;
        list.appendChild(el);
      });
    }

    function renderOrders(){
      const wrap=$("#zd-ordersList");
      wrap.innerHTML="";
      const n=new Date(),ops=getOpsDate(n),dow=ops.getDay(),even=isEvenWeek(ops);
      const td=state.ordersRules.filter(r=>(r.weekdays||[]).includes(dow)&&(!r.evenWeeks||even));
      if(!td.length){
        wrap.innerHTML=`<div class="zd-item"><div class="zd-name">Geen bestellingen</div></div>`;
        return;
      }
      td.forEach(r=>{
        let limit=new Date(ops);
        if(r.deadline==="00:00"){
          limit.setDate(limit.getDate()+1);
          limit.setHours(0,0,0,0);
        }else{
          const [h,m]=(r.deadline||"23:59").split(":").map(Number);
          limit.setHours(h,m||0,0,0);
        }
        const diff=Math.round((limit-n)/60000);
        let type="open",lab=`vóór ${r.deadline}`;
        if(diff<0){type="bad";lab="Te laat";}
        else if(diff<=60){type="warn";lab=`Binnen ${diff}m`;}

        const el=document.createElement("div");
        el.className="zd-item";
        el.innerHTML=`<div class="zd-name">${r.vendor} <em>— ${lab}</em></div>`;
        wrap.appendChild(el);
      });
    }

    function isYellowCratesDay(ops){
      const start = new Date(YELLOW_CRATES_START + "T00:00:00");
      const msPerDay = 24*60*60*1000;
      const opsMid = new Date(ops);
      opsMid.setHours(0,0,0,0);
      const daysDiff = Math.floor((opsMid - start.getTime())/msPerDay);
      if(daysDiff < 0) return false;
      const weeksDiff = Math.floor(daysDiff / 7);
      return weeksDiff % 2 === 0; // om de week
    }

    function renderContainers(){
      const lc = $("#zd-wasteContainers");
      const le = $("#zd-wasteEmballage");
      if(!lc || !le) return;
      lc.innerHTML=""; le.innerHTML="";

      const now = new Date();
      const ops=getOpsDate(now);
      const dow=ops.getDay();
      const todayStr = opsDateStrToday();

      /* Emballage: vast schema + gele kratten (om de week op maandag) */
      const emballage = EMBALLAGE_SCHEDULE[dow] ? [...EMBALLAGE_SCHEDULE[dow]] : [];
      if(dow===1 && isYellowCratesDay(ops)){ // maandag
        emballage.push("Gele Zusje kratten klaarzetten");
      }

      /* Containers: agenda eerst, anders fallback */
      let containers = [];
      if (containersData) {
        if (Array.isArray(containersData.items)) {
          containers = containersData.items
            .filter(it=>{
              const s = it.start || it.startTime || it.date || it.dateISO;
              if(!s) return true;
              const evStr = ymdInAmsterdam(s);
              if(!evStr) return false;
              return evStr === todayStr;
            })
            .map(it=> String(it.title || it.name || "").trim())
            .filter(Boolean);
        }
        else if (Array.isArray(containersData.containers)) {
          containers = containersData.containers.slice();
        }
      }

      if (containers.length === 0) {
        containers = FALLBACK_CONTAINERS[dow] ? [...FALLBACK_CONTAINERS[dow]] : [];
        if (dow === 4 && isEvenWeek(ops)) {
          if(!containers.includes(THURSDAY_PLASTIC_LABEL)) containers.push(THURSDAY_PLASTIC_LABEL);
        }
      }

      /* Render containers */
      if (containers.length === 0){
        lc.innerHTML = `<div class="zd-item"><div class="zd-name">—</div></div>`;
      } else {
        containers.forEach(n=>{
          const el=document.createElement("div");
          el.className="zd-item";
          el.innerHTML = `<div class="zd-name">${n}</div>`;
          lc.appendChild(el);
        });
      }

      /* Render emballage */
      if (emballage.length === 0){
        le.innerHTML = `<div class="zd-item"><div class="zd-name">—</div></div>`;
      } else {
        emballage.forEach(n=>{
          const el=document.createElement("div");
          el.className="zd-item";
          el.innerHTML = `<div class="zd-name">${n}</div>`;
          le.appendChild(el);
        });
      }
    }

    function renderAll(){
      renderHeader();
      renderChecklists();
      renderPeriodic();
      renderOrders();
      renderContainers();
      fitFrame();
    }

    /* ====== Schalen voor 1080p ====== */
    const FRAME_W = 1920, FRAME_H = 1080, SAFE_MARGIN_PX = 8;

    function fitFrame(){
      const shell = document.getElementById('dashboard-shell');
      const frame = document.getElementById('zd-frame');

      const viewW = Math.max(1, window.innerWidth  || shell.clientWidth  || document.documentElement.clientWidth);
      const viewH = Math.max(1, window.innerHeight || shell.clientHeight || document.documentElement.clientHeight);

      const base = Math.min(
        (viewW - SAFE_MARGIN_PX) / FRAME_W,
        (viewH - SAFE_MARGIN_PX) / FRAME_H
      );

      const EXTRA_SHRINK = 0.99;
      const scale = base * EXTRA_SHRINK;

      frame.style.transform = `translate(-50%, -50%) scale(${scale})`;
    }

    async function toggleFS(){
      try{
        if(document.fullscreenElement){
          await document.exitFullscreen();
        }else{
          const el = document.getElementById('dashboard-shell');
          if(el.requestFullscreen) await el.requestFullscreen();
          else if(document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen();
        }
      }catch(_){}
    }
    document.addEventListener('keydown', (e)=>{ if((e.key||'').toLowerCase()==='f') toggleFS(); });

    window.addEventListener('resize', fitFrame);
    window.addEventListener('orientationchange', fitFrame);
    document.addEventListener('fullscreenchange', fitFrame);
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) fitFrame(); });
    if (document.fonts && document.fonts.ready) { document.fonts.ready.finally(fitFrame); }

    /* ====== Init ====== */
    fitFrame();
    renderHeader();
    loadAll();
    setInterval(()=>{ renderHeader(); fitFrame(); },1000);
    setInterval(()=>{ loadAll(); }, CONFIG.refreshMs);
  })();
  </script>
</body>
</html>
